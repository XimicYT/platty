const express = require('express');
const app = express();
const http = require('http');
const server = http.createServer(app);
const { Server } = require("socket.io");

// 1. ALLOW CONNECTIONS
const io = new Server(server, {
    cors: { origin: "*", methods: ["GET", "POST"] }
});

// --- CONFIGURATION ---
const ADMIN_PASSWORD = "admin"; // <--- CHANGE THIS PASSWORD

app.get('/health', (req, res) => { res.status(200).send('OK'); });
app.use(express.static('public'));

// --- GAME STATE ---
let players = {};
let taggerId = null;

// DEFAULT MAP (The one you provided)
let currentMapLayout = [
    "1111111111111111111111111111111.11111111111111111111111111111111111111111111111111111111111111111111",
    "11................................................................................................11",
    "11................................................................................................11",
    "11...........................11111................................................................11",
    "11................................................................................................11",
    "11.............................P.....................................1............................11",
    "11.........................111111111................................1.............................11",
    "11.......................11.........11.............................1..............................11",
    "11.......111......................................................1...................111.........11",
    "11.......1.1....................................1.....................................1.1.........11",
    "11.......1.1....................................11....................................1.1.........11",
    "11.......1.1........1...........................111...................................1.1.........11",
    "11.......1.1.........1............1111111111111111111111..............................1.1.........11",
    "11.......1.1..........1................................1..............................1.1.........11",
    "11.......1.1...........................................1..............................1.1.........11",
    "11.......1.1......................1....................1..............................1.1.........11",
    "11.......1.1......................1....................1..............................1.1.........11",
    "11.......1.1......................1....................1..............................1.1.........11",
    "11.......1.1......................1....................1..............................1.1.........11",
    "11.......1.1.......11111..1.......1....................1.......11111111...............1.1.........11",
    "11.......1.1.......1......1.......1....................1.......1......1...............1.1.........11",
    "11.......1.1.......1......1.......1............................1......1...............1.1.........11",
    "11.......1.1.......1......1.......1.........22.................1......1...............1.1.........11",
    "11.......1.1.......1......1.......1111111111111111111111.......1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1..............11111111..............1......1...............1.1.........11",
    "11.......1.1.......1......1..............1......1..............1......1...............1.1.........11",
    "11.......1.1.......1......1..............1.2222.1..............1......1...............1.1.........11",
    "11.......1.1.......1......1..............11111111..............1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......................1.1.........11",
    "11.......1.1.......1......1....................................1......................1.1.........11",
    "11.......1.1.......1......1...............1....................1......1...............1.1.........11",
    "11.......1.1.......1......1..............1.....................1......1...............1.1.........11",
    "11.......1.1.......1......1.............1......................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1.......1......1....................................1......1...............1.1.........11",
    "11.......1.1..............1....................................1......1...............1.1.........11",
    "11.......1.1..............1........11.11..........11111........1......1...............1.1.........1.",
    "11.......1.1.......1......1........1...1..........1...1........1......1...............1.1.........1.",
    "11.......1.1.......1......1........1...1..........1............1......1...............1.1.........1.",
    "11.......1.1.......1......1........1...1..........1...................1...............1.1.........11",
    "11.......1.1.......1......1........1...1..........1...1...............1...............1.1.........11",
    "11.......1.1.......11111111........1...1..........1...1........11111111...............1.1.........11",
    "11.......1.1.......................1...1..........1...1...............................1.1.........11",
    "11.......1.1.......................1...1..........1...1...............................1.1.........11",
    "11.......1.1.......................1...1..........1...1...............................1.1.........11",
    "11.......1.1.......................1...1..........1...1.............1.................1.1.........11",
    "11.......1.1.......................1...1..........1...1............1..................1.1.........11",
    "11.......111.......................1...1..........1...1...........1...................111.........11",
    "11.....................................1..........1...1...........................................1.",
    "11.....................................1..............1...........................................1.",
    "11............22...................1...1..............1...................22......................11",
    "111111111111111111111111111111111111...111111111111...1111111111111111111111111111111111111111111111",
    "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
];

function pickRandomTagger() {
    const ids = Object.keys(players);
    if (ids.length > 0) {
        taggerId = ids[Math.floor(Math.random() * ids.length)];
        io.emit('taggerUpdate', taggerId);
    } else {
        taggerId = null;
    }
}

io.on('connection', (socket) => {
    console.log('User connected:', socket.id);

    // --- ADMIN: UPDATE MAP ---
    socket.on('adminUpdateMap', (data, callback) => {
        if (data.password === ADMIN_PASSWORD) {
            console.log("MAP UPDATED BY ADMIN");
            currentMapLayout = data.layout;
            
            // 1. Tell Builder it succeeded
            callback({ success: true });

            // 2. Alert all players and reload their page
            io.emit('mapUpdatedAlert');
            
            // 3. Reset game state
            players = {};
            taggerId = null;
        } else {
            callback({ success: false, message: "WRONG PASSWORD" });
        }
    });

    socket.on('requestJoin', (data, callback) => {
        const requestedName = data.username.toUpperCase();
        const isDuplicate = Object.values(players).some(p => p.username === requestedName);

        if (isDuplicate) {
            callback({ success: false, message: "NAME TAKEN" });
        } else {
            players[socket.id] = {
                x: 0, y: 0, 
                username: requestedName, 
                color: data.color,
                id: socket.id,
                facing: 1,
                isDashing: false
            };
            
            // SEND THE CURRENT MAP TO THE PLAYER ON JOIN
            callback({ success: true, id: socket.id, mapLayout: currentMapLayout });
            
            socket.broadcast.emit('newPlayer', { id: socket.id, player: players[socket.id] });
            socket.emit('currentPlayers', players);
            socket.emit('taggerUpdate', taggerId);

            if (Object.keys(players).length >= 2 && !taggerId) pickRandomTagger();
        }
    });

    socket.on('playerMovement', (movementData) => {
        if (players[socket.id]) {
            players[socket.id] = { ...players[socket.id], ...movementData };
            socket.broadcast.emit('playerMoved', { id: socket.id, ...movementData });
        }
    });

    socket.on('playerDash', () => socket.broadcast.emit('otherPlayerDash', socket.id));

    socket.on('tagHit', (targetId) => {
        if (socket.id === taggerId && players[targetId]) {
            taggerId = targetId; 
            io.emit('taggerUpdate', taggerId); 
        }
    });

    socket.on('disconnect', () => {
        delete players[socket.id];
        io.emit('playerDisconnected', socket.id);
        if (socket.id === taggerId) pickRandomTagger();
    });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});